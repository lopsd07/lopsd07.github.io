# Spring Boot Admin

Spring Boot 有一个非常好用的监控和管理的开源软件，就是 Spring Boot Admin。该软件能够将 Actuator 中的信息进行界面化的展示，也可以监控所有 Spring Boot 应用的健康状况，提供实时警报功能。

主要的功能点有：

- 显示应用程序的监控状态
- 应用程序上下线监控
- 查看 JVM，线程信息
- 可视化的查看日志以及下载日志文件
- 动态切换日志级别
- Http 请求信息跟踪
- 其他功能点……


可点击 [Spring-boot-admin](https://github.com/codecentric/spring-boot-admin) 了解更多。

## 创建Spring Boot Admin项目

创建一个 Spring Boot 项目，用于展示各个服务中的监控信息，加上 Spring Boot Admin 的依赖，具体代码如下所示。

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>de.codecentric</groupId>
    <artifactId>spring-boot-admin-starter-server</artifactId>
    <version>2.0.2</version>
</dependency>
```

创建一个启动类，具体代码如下所示。

```java
@EnableAdminServer
@SpringBootApplication
public class App {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }
}
```

在属性文件中增加端口配置信息：

```properties
server.port=9091
```

启动程序，访问 Web 地址 http://localhost:9091 就可以看到主页面了，这个时候是没有数据的。

## 将服务注册到 Spring Boot Admin

创建一个 Spring Boot 项目，名称为 spring-boot-admin-client。添加 Spring Boot Admin Client 的 Maven 依赖，代码如下所示。

```xml
<dependency>
    <groupId>de.codecentric</groupId>
    <artifactId>spring-boot-admin-starter-client</artifactId>
    <version>2.0.2</version>
</dependency>
```

然后在属性文件中添加下面的配置：

```properties
server.port=9092
spring.boot.admin.client.url=http://localhost:9091
```

spring.boot.admin.client.url：Spring Boot Admin 服务端地址。

将服务注册到 Admin 之后我们就可以在 Admin 的 Web 页面中看到我们注册的服务信息。

点击实例信息跳转到详细页面，可以查看更多的信息。

可以看到详情页面并没有展示丰富的监控数据，这是因为没有将 spring-boot-admin-client 的端点数据暴露出来。

在 spring-boot-admin-client 中加入 actuator 的 Maven 依赖，代码如下所示。

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

然后在属性文件中追加下面的配置：

```properties
management.endpoints.web.exposure.include=*
```

> `management.endpoints.web.exposure.include=*`：暴露所有的 actuator 端点信息重启 spring-boot-admin-client，我们就可以在详情页面看到更多的数据。

## 查看服务日志

Spring Boot Admin 提供了基于 Web 页面的方式实时查看服务输出的本地日志，前提是服务中配置了 logging.file。

我们在 spring-boot-admin-client 的属性文件中增加下面的内容：

```properties
logging.file=/Users/zhangsan/Downloads/spring-boot-admin-client.log
```

重启服务，就可以在 Admin Server 的 Web 页面中看到新加了一个 Logfile 菜单。

## 开启认证

监控类的数据 Web 管理端最好不要设置成直接通过输入访问地址就可以访问，必须得进行用户认证才行，以保证数据的安全性。Spring Boot Admin 开启认证也可以借助于 spring-boot-starter-security。

加入依赖，代码如下所示。

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

然后在属性文件里面配置认证信息：

```properties
spring.security.user.name=zhangsan
spring.security.user.password=123456
```

自定义安全配置类，代码如下所示。

```java
@Configuration
public static class SecurityPermitAllConfig extends WebSecurityConfigurerAdapter {
    private final String adminContextPath;
    public SecurityPermitAllConfig(AdminServerProperties adminServerProperties) {
        this.adminContextPath = adminServerProperties.getContextPath();
    }
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        SavedRequestAwareAuthenticationSuccessHandler successHandler = new SavedRequestAwareAuthenticationSuccessHandler();
        successHandler.setTargetUrlParameter("redirectTo");
        // 静态资源和登录页面可以不用认证
        http.authorizeRequests().antMatchers(adminContextPath + "/assets/**").permitAll()
                .antMatchers(adminContextPath + "/login").permitAll()
                // 其他请求必须认证
                .anyRequest().authenticated()
                // 自定义登录和退出
                .and().formLogin().loginPage(adminContextPath + "/login").successHandler(successHandler).and().logout()
                .logoutUrl(adminContextPath + "/logout")
                // 启用HTTP-Basic, 用于Spring Boot Admin Client注册
                .and().httpBasic().and().csrf().disable();
    }
}
```

重启程序，然后就会发现需要输入用户名和密码才能访问 Spring Boot Admin 的 Web 管理端。

> 如果 Spring Boot Admin 服务开启了认证，监控的服务中也需要配置对应的用户名和密码，否则会注册失败。

在 spring-boot-admin-client 属性文件中加上用户认证信息：

```properties
spring.boot.admin.client.username=zhangsan
spring.boot.admin.client.password=123456
```

> 账号密码需要跟 Spring Boot Admin Server 一致。